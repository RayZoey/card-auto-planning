# 前端对接接口说明

## 接口基础信息

### 认证方式
- **认证类型**: JWT Token
- **请求头**: `Authorization: Bearer <token>`
- **Token获取**: 通过登录接口获取

### 响应格式
```typescript
interface ApiResponse<T = any> {
  code: number;        // HTTP状态码
  data: T;            // 响应数据
  message: string;    // 响应消息
}
```

### 错误处理
```typescript
interface ErrorResponse {
  code: number;
  message: string;
  validation?: {
    isValid: boolean;
    currentMinutes: number;
    maxMinutes: number;
    message?: string;
  };
}
```

## 1. 计划管理接口

### 1.1 获取用户计划列表

**接口**: `GET /user-plan`

**请求参数**:
```typescript
interface PlanListQuery {
  page?: number;           // 页码，默认1
  pageSize?: number;       // 每页数量，默认10
  id?: number;            // 计划ID（可选）
  name?: string;          // 计划名称（可选）
  status?: string;        // 计划状态（可选）
}
```

**响应数据**:
```typescript
interface PlanListResponse {
  data: UserPlan[];
  meta: {
    pagination: {
      page_size: number;
      current_page: number;
      total: number;
    };
  };
}

interface UserPlan {
  id: number;
  user_id: number;
  name: string;
  status: 'PROGRESS' | 'PAUSE' | 'COMPLETE';
  planned_start_time: string;
  planned_end_time: string;
  created_at: string;
  updated_at: string;
}
```

**前端调用示例**:
```typescript
const getPlanList = async (query: PlanListQuery) => {
  const response = await fetch('/user-plan?' + new URLSearchParams(query), {
    headers: {
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json'
    }
  });
  return await response.json();
};
```

### 1.2 创建计划（模板）

**接口**: `POST /user-plan/generate-by-template/:templateId`

**请求参数**:
- `templateId`: 模板ID（路径参数）

**响应数据**:
```typescript
interface CreatePlanResponse {
  code: number;
  data: string;  // "OK"
  message: string;
}
```

**前端调用示例**:
```typescript
const createPlanFromTemplate = async (templateId: number) => {
  const response = await fetch(`/user-plan/generate-by-template/${templateId}`, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json'
    }
  });
  return await response.json();
};
```

### 1.3 创建计划（手动）

**接口**: `POST /user-plan`

**请求参数**:
```typescript
interface CreatePlanRequest {
  name: string;
  status?: 'PROGRESS' | 'PAUSE' | 'COMPLETE';
}
```

**响应数据**:
```typescript
interface CreatePlanResponse {
  code: number;
  data: UserPlan;
  message: string;
}
```

### 1.4 获取计划详情

**接口**: `GET /user-plan/:id`

**响应数据**:
```typescript
interface PlanDetailResponse {
  code: number;
  data: {
    id: number;
    user_id: number;
    name: string;
    status: string;
    planned_start_time: string;
    planned_end_time: string;
    UserTaskGroup: Array<{
      id: number;
      name: string;
      UserTask: UserTask[];
    }>;
  };
  message: string;
}
```

### 1.5 手动触发自动规划

**接口**: `POST /user-plan/:id/trigger-planning`

**响应数据**:
```typescript
interface TriggerPlanningResponse {
  code: number;
  data: any;
  message: string;
}
```

### 1.6 更新规划

**接口**: `POST /user-plan/:id/update-plan`

**响应数据**:
```typescript
interface UpdatePlanResponse {
  code: number;
  data: any;
  message: string;
}
```

### 1.7 获取每日任务概览

**接口**: `GET /user-plan/:id/daily-overview`

**请求参数**:
- `startDate`: 开始日期（可选）
- `endDate`: 结束日期（可选）

**响应数据**:
```typescript
interface DailyOverviewResponse {
  code: number;
  data: {
    plan: {
      id: number;
      name: string;
      status: string;
      planned_start_time: string;
      planned_end_time: string;
    };
    dailyOverview: Array<{
      date: string;
      tasks: DailyTask[];
      totalMinutes: number;
      completedMinutes: number;
    }>;
  };
  message: string;
}

interface DailyTask {
  id: number;
  user_id: number;
  plan_id: number;
  user_task_id: number;
  date: string;
  planned_minutes: number;
  done_minutes: number;
  status: 'PLANNED' | 'AHEAD' | 'DELAY' | 'GIVE_UP';
  seq: number;
  user_task: {
    id: number;
    name: string;
    timing_type: 'POMODORO' | 'FREE_TIMING' | 'UNTIMING';
    status: string;
    is_manually_adjusted: boolean;
  };
}
```

## 2. 任务操作接口

### 2.1 插入任务

**接口**: `POST /user/task-operation/insert/:planId`

**请求参数**:
```typescript
interface InsertTaskRequest {
  name: string;
  priority: number;                    // 1-10
  background?: string;
  suggested_time_start?: string;
  suggested_time_end?: string;
  remark?: string;
  annex_type?: 'IMG' | 'FILE' | 'URL';
  annex?: string;
  timing_type: 'POMODORO' | 'FREE_TIMING' | 'UNTIMING';
  occupation_time?: number;            // 分钟
  can_divisible: boolean;
  task_group_id?: number;
  target_date: string;                 // YYYY-MM-DD
  target_seq?: number;                 // 可选，不传则插入到最后
}
```

**响应数据**:
```typescript
interface TaskOperationResponse {
  success: boolean;
  message?: string;
  validation?: {
    isValid: boolean;
    currentMinutes: number;
    maxMinutes: number;
    message?: string;
  };
  data?: UserTask;
}
```

**前端调用示例**:
```typescript
const insertTask = async (planId: number, taskData: InsertTaskRequest) => {
  const response = await fetch(`/user/task-operation/insert/${planId}`, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(taskData)
  });
  return await response.json();
};
```

### 2.2 切割任务

**接口**: `POST /user/task-operation/cut/:planId`

**请求参数**:
```typescript
interface CutTaskRequest {
  task_id: number;
  segments_count: number;              // 至少2段
}
```

**响应数据**:
```typescript
interface CutTaskResponse {
  success: boolean;
  message: string;
  data?: {
    task: UserTask;
    segments: UserTaskSegment[];
  };
}
```

### 2.3 跳过任务

**接口**: `POST /user/task-operation/skip/:planId`

**请求参数**:
```typescript
interface SkipTaskRequest {
  task_id: number;
  reason?: string;
}
```

**响应数据**:
```typescript
interface SkipTaskResponse {
  success: boolean;
  message: string;
  data?: {
    task_id: number;
  };
}
```

### 2.4 推迟任务

**接口**: `POST /user/task-operation/postpone/:planId`

**请求参数**:
```typescript
interface PostponeTaskRequest {
  task_id: number;
  new_date: string;                   // YYYY-MM-DD
  new_seq?: number;                   // 可选，不传则插入到最后
}
```

**响应数据**:
```typescript
interface PostponeTaskResponse {
  success: boolean;
  message?: string;
  validation?: {
    isValid: boolean;
    currentMinutes: number;
    maxMinutes: number;
    message?: string;
  };
  data?: {
    task_id: number;
    new_date: string;
    new_seq: number;
  };
}
```

## 3. 任务状态管理接口

### 3.1 修改任务状态

**接口**: `POST /user-task/:id/change-status`

**请求参数**:
```typescript
interface ChangeStatusRequest {
  status: 'PROGRESS' | 'PAUSE' | 'COMPLETE';
}
```

**响应数据**:
```typescript
interface ChangeStatusResponse {
  code: number;
  data: UserTask;
  message: string;
}
```

### 3.2 学习心跳

**接口**: `POST /user-task/:id/heartbeat`

**响应数据**:
```typescript
interface HeartbeatResponse {
  ok: boolean;
}
```

## 4. 每日验证接口

### 4.1 验证当日任务时间

**接口**: `POST /user/daily-validation/validate/:planId`

**请求参数**:
```typescript
interface ValidateDailyTasksRequest {
  date: string;                       // YYYY-MM-DD
  additionalTask?: {
    timing_type: 'POMODORO' | 'FREE_TIMING' | 'UNTIMING';
    occupation_time?: number;
  };
}
```

**响应数据**:
```typescript
interface ValidateDailyTasksResponse {
  code: number;
  data: {
    isValid: boolean;
    currentMinutes: number;
    maxMinutes: number;
    pomodoroCount: number;
    freeTimingMinutes: number;
    untimingCount: number;
    message?: string;
    suggestions?: string[];
  };
  message: string;
}
```

### 4.2 获取当日任务概览

**接口**: `GET /user/daily-validation/overview/:planId`

**请求参数**:
- `date`: 日期（查询参数）

**响应数据**:
```typescript
interface DailyTaskOverviewResponse {
  code: number;
  data: {
    date: string;
    tasks: DailyTask[];
    validation: ValidateDailyTasksResponse['data'];
    summary: {
      totalTasks: number;
      totalMinutes: number;
      maxMinutes: number;
      utilizationRate: number;
    };
  };
  message: string;
}
```

## 5. 前端集成流程

### 5.1 计划创建流程

```typescript
// 1. 基于模板创建计划
const createPlanFromTemplate = async (templateId: number) => {
  try {
    // 创建计划
    const createResult = await fetch(`/user-plan/generate-by-template/${templateId}`, {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${token}` }
    });
    
    if (!createResult.ok) throw new Error('创建计划失败');
    
    const planData = await createResult.json();
    const planId = planData.data.id;
    
    // 触发自动规划
    const planningResult = await fetch(`/user-plan/${planId}/trigger-planning`, {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${token}` }
    });
    
    if (!planningResult.ok) throw new Error('自动规划失败');
    
    return planId;
  } catch (error) {
    console.error('创建计划失败:', error);
    throw error;
  }
};
```

### 5.2 任务调整流程

```typescript
// 插入任务前的验证
const insertTaskWithValidation = async (planId: number, taskData: InsertTaskRequest) => {
  try {
    // 先验证时间限制
    const validation = await fetch(`/user/daily-validation/validate/${planId}`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        date: taskData.target_date,
        additionalTask: {
          timing_type: taskData.timing_type,
          occupation_time: taskData.occupation_time
        }
      })
    });
    
    const validationResult = await validation.json();
    
    if (!validationResult.data.isValid) {
      // 显示错误信息和优化建议
      showError(validationResult.data.message);
      showSuggestions(validationResult.data.suggestions);
      return;
    }
    
    // 验证通过，执行插入
    const result = await fetch(`/user/task-operation/insert/${planId}`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(taskData)
    });
    
    const insertResult = await result.json();
    
    if (insertResult.success) {
      showSuccess('任务插入成功');
      refreshTaskList();
    } else {
      showError(insertResult.message);
    }
  } catch (error) {
    console.error('插入任务失败:', error);
    showError('操作失败，请重试');
  }
};
```

### 5.3 完成当日学习流程

```typescript
const handleCompleteDailyLearning = async (planId: number, todayTasks: DailyTask[]) => {
  const completedTasks = todayTasks.filter(task => task.user_task.status === 'COMPLETE');
  const uncompletedTasks = todayTasks.filter(task => task.user_task.status === 'WAITING');
  
  if (uncompletedTasks.length === 0) {
    // 所有任务都完成了
    const choice = await showChoiceDialog([
      '学点别的（自己新建任务）',
      '提前学（从未来任务中选择）',
      '不学了（完成今日学习）'
    ]);
    
    switch (choice) {
      case 0:
        // 学点别的 - 不需要后端介入
        showCreateTaskDialog();
        break;
      case 1:
        // 提前学 - 调用推迟任务接口
        showAdvanceTaskDialog();
        break;
      case 2:
        // 不学了 - 完成
        showSuccess('今日学习完成！');
        break;
    }
  } else {
    // 有任务未完成
    const choice = await showChoiceDialog([
      '跳过未完成任务',
      '延期加时学（明天加总学时）',
      '延期学（明天学习，触发重新规划）'
    ]);
    
    switch (choice) {
      case 0:
        // 跳过未完成任务
        for (const task of uncompletedTasks) {
          await skipTask(planId, { task_id: task.user_task_id });
        }
        showSuccess('未完成任务已跳过');
        break;
      case 1:
        // 延期加时学
        for (const task of uncompletedTasks) {
          await postponeTask(planId, {
            task_id: task.user_task_id,
            new_date: getTomorrowDate()
          });
        }
        showSuccess('任务已延期到明天');
        break;
      case 2:
        // 延期学 + 触发重新规划
        for (const task of uncompletedTasks) {
          await postponeTask(planId, {
            task_id: task.user_task_id,
            new_date: getTomorrowDate()
          });
        }
        await updatePlan(planId);
        showSuccess('任务已延期并重新规划');
        break;
    }
  }
};
```

## 6. 错误处理

### 6.1 统一错误处理

```typescript
const handleApiError = (error: any) => {
  if (error.validation) {
    // 时间验证错误
    showError(error.validation.message);
    showSuggestions(error.validation.suggestions);
  } else if (error.message) {
    // 业务逻辑错误
    showError(error.message);
  } else {
    // 系统错误
    showError('操作失败，请重试');
  }
};
```

### 6.2 网络错误处理

```typescript
const apiCall = async (url: string, options: RequestInit) => {
  try {
    const response = await fetch(url, options);
    
    if (!response.ok) {
      if (response.status === 401) {
        // Token过期，跳转登录
        redirectToLogin();
        return;
      }
      throw new Error(`HTTP ${response.status}`);
    }
    
    return await response.json();
  } catch (error) {
    if (error.name === 'TypeError') {
      // 网络错误
      showError('网络连接失败，请检查网络设置');
    } else {
      showError('操作失败，请重试');
    }
    throw error;
  }
};
```

## 7. 数据缓存策略

### 7.1 计划数据缓存

```typescript
class PlanCache {
  private cache = new Map<string, any>();
  private ttl = 5 * 60 * 1000; // 5分钟过期
  
  get(key: string) {
    const item = this.cache.get(key);
    if (item && Date.now() - item.timestamp < this.ttl) {
      return item.data;
    }
    return null;
  }
  
  set(key: string, data: any) {
    this.cache.set(key, {
      data,
      timestamp: Date.now()
    });
  }
  
  clear() {
    this.cache.clear();
  }
}
```

### 7.2 任务状态同步

```typescript
const syncTaskStatus = (taskId: number, newStatus: string) => {
  // 更新本地缓存
  updateLocalTaskStatus(taskId, newStatus);
  
  // 更新UI
  updateTaskUI(taskId, newStatus);
  
  // 如果状态变更影响每日概览，刷新概览
  if (['COMPLETE', 'SKIP'].includes(newStatus)) {
    refreshDailyOverview();
  }
};
```
