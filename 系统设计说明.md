# 自动规划系统设计说明

## 系统架构

### 技术栈
- **后端框架**: NestJS
- **数据库**: MySQL + Prisma ORM
- **架构模式**: 前后端分离
- **认证方式**: JWT Token

### 核心模块

#### 1. 数据模型层 (Database Layer)

**核心实体关系：**
```
User (用户)
├── UserPlan (学习计划)
│   ├── UserTaskGroup (任务集)
│   │   └── UserTask (任务)
│   └── UserDailyTask (每日任务分配)
├── UserStudyConfig (学习配置)
└── UserPlanOperation (操作记录)

PlanTemplate (计划模板)
├── PlanTemplateAndTaskGroupRelation (模板-任务集关系)
└── PlatformTaskGroup (平台任务集)
    └── PlatformTask (平台任务)
```

**关键字段说明：**
- `UserTask.planned_date`: 算法分配的执行日期
- `UserTask.seq`: 同一天内的执行顺序
- `UserTask.is_manually_adjusted`: 是否被手动调整过
- `UserStudyConfig.max_daily_minutes`: 每日最大学习时间限制
- `UserDailyTask.planned_minutes`: 算法分配的学习时长

#### 2. 业务逻辑层 (Service Layer)

**AutoPlanningService (自动规划服务)**
- 核心算法：5种规划模式
- 时间分配：基于每日最大学习时间
- 任务排序：任务集 + 优先级 + 顺序

**UserTaskService (任务服务)**
- 任务状态管理：WAITING → PROGRESS → PAUSE → COMPLETE
- 任务操作：插入、切割、跳过、推迟
- 时间统计：基于心跳机制的学习时长计算

**DailyValidationService (每日验证服务)**
- 时间限制验证
- 任务类型分析（番茄钟、自由计时、不计时）
- 优化建议生成

#### 3. 控制器层 (Controller Layer)

**RESTful API设计**
- 统一的响应格式
- JWT认证保护
- 角色权限控制
- 错误处理机制

## 核心算法设计

### 自动规划算法

**输入参数：**
- 任务列表（包含优先级、时长、任务集信息）
- 开始日期和结束日期
- 用户配置（每日最大学习时间、规划模式）

**算法流程：**
1. 根据规划模式对任务进行排序
2. 按日期顺序分配任务
3. 检查每日时间限制
4. 生成每日任务分配记录

**5种规划模式：**
- MODE1: 任务集 + 优先度（先任务集前移，再优先度补空）
- MODE2: 任务集 + 顺序（先任务集前移，再顺序补空）
- MODE3: 不考虑任务集 + 优先度（全局优先度倒推）
- MODE4: 不考虑任务集 + 顺序（全局顺序倒推）
- MODE5: 全局优先度（跨天一次性重排）

### 任务状态管理

**状态流转：**
```
WAITING → PROGRESS → PAUSE → COMPLETE
    ↓         ↓
   SKIP    COMPLETE
```

**时间统计机制：**
- 基于心跳记录学习时长
- 支持暂停和恢复
- 自动处理异常断线

### 每日时间验证

**验证规则：**
- 检查当日总学习时间是否超过限制
- 分析不同任务类型的时间分配
- 提供优化建议

**任务类型处理：**
- 番茄钟：按25分钟计算
- 自由计时：按实际时长计算
- 不计时：按任务数量计算

## 数据一致性保证

### 事务处理
- 所有任务操作使用数据库事务
- 确保操作原子性
- 防止并发冲突

### 操作记录
- 记录所有用户操作
- 支持操作撤销和重放
- 便于问题追踪

### 数据同步
- 任务状态变更自动更新相关表
- 每日任务分配与任务计划日期同步
- 操作记录与业务数据同步

## 性能优化

### 数据库优化
- 合理的索引设计
- 查询条件优化
- 分页查询支持

### 缓存策略
- 用户配置缓存
- 计划数据缓存
- 减少重复查询

### 并发控制
- 乐观锁机制
- 操作幂等性
- 防止重复操作

## 扩展性设计

### 算法扩展
- 支持新增规划模式
- 可配置的排序规则
- 灵活的分配策略

### 功能扩展
- 任务依赖关系
- 团队协作功能
- 学习分析报告

### 集成扩展
- 第三方日历集成
- 学习资源推荐
- 进度同步功能

## 安全设计

### 认证授权
- JWT Token认证
- 角色权限控制
- 用户数据隔离

### 数据安全
- 输入参数验证
- SQL注入防护
- XSS攻击防护

### 操作安全
- 操作权限验证
- 数据完整性检查
- 异常操作拦截

## 监控和日志

### 操作日志
- 用户操作记录
- 系统异常日志
- 性能监控数据

### 业务监控
- 任务完成率统计
- 学习时长分析
- 用户行为分析

### 系统监控
- 接口响应时间
- 数据库性能
- 服务器资源使用
