# 用户场景及流程说明

## 场景1：用户创建学习计划

### 1.1 基于模板创建计划

**用户操作流程：**
1. 用户登录系统
2. 进入计划管理页面
3. 浏览可用的计划模板
4. 选择心仪的模板
5. 点击"使用此模板创建计划"
6. 系统自动创建计划并复制任务
7. 用户手动触发自动规划

**系统处理流程：**
```
用户选择模板 → 验证模板可用性 → 创建UserPlan → 复制任务集和任务 → 返回计划ID
用户点击触发规划 → 获取用户配置 → 执行自动规划算法 → 生成每日任务分配
```

**关键接口：**
- `POST /user-plan/generate-by-template/:templateId`
- `POST /user-plan/:id/trigger-planning`

### 1.2 手动创建计划

**用户操作流程：**
1. 用户点击"创建新计划"
2. 填写计划基本信息
3. 手动添加任务集和任务
4. 点击"开始规划"
5. 系统执行自动规划

**系统处理流程：**
```
用户创建计划 → 创建UserPlan → 用户添加任务 → 触发自动规划 → 生成每日任务分配
```

**关键接口：**
- `POST /user-plan`
- `POST /user-plan/:id/trigger-planning`

## 场景2：用户调整当日任务

### 2.1 插入新任务

**用户操作流程：**
1. 用户查看当日任务列表
2. 点击"添加任务"
3. 填写任务信息（名称、类型、时长等）
4. 选择插入位置
5. 系统验证时间限制
6. 创建任务并更新当日安排

**系统处理流程：**
```
用户填写任务信息 → 验证计划权限 → 验证当日时间限制 → 创建任务 → 更新每日任务分配 → 记录操作
```

**验证规则：**
- 检查当日总学习时间是否超过限制
- 如果超限，返回错误信息和优化建议
- 如果通过，创建任务并分配

### 2.2 切割任务

**用户操作流程：**
1. 用户选择要切割的任务
2. 设置分割段数
3. 系统自动计算每段时长
4. 创建任务分割段

**系统处理流程：**
```
用户选择任务 → 验证任务可分割性 → 计算分割段时长 → 创建UserTaskSegment记录 → 记录操作
```

**分割规则：**
- 平均分配时长，最后一段包含余数
- 每段独立管理，可分配到不同日期

### 2.3 跳过任务

**用户操作流程：**
1. 用户选择要跳过的任务
2. 填写跳过原因（可选）
3. 确认跳过操作
4. 任务状态更新为跳过

**系统处理流程：**
```
用户选择任务 → 验证任务状态 → 更新任务状态为SKIP → 更新每日任务状态为GIVE_UP → 记录操作
```

### 2.4 推迟任务

**用户操作流程：**
1. 用户选择要推迟的任务
2. 选择新的执行日期
3. 选择在新日期的位置（可选）
4. 系统验证新日期时间限制
5. 更新任务计划日期

**系统处理流程：**
```
用户选择任务和新日期 → 验证新日期时间限制 → 删除原日期记录 → 创建新日期记录 → 更新任务计划日期 → 记录操作
```

## 场景3：用户完成当日学习

### 3.1 所有任务都完成了

**用户操作流程：**
1. 用户完成所有当日任务
2. 点击"完成今日学习"
3. 系统显示选择界面：
   - 学点别的（自己新建任务）
   - 提前学（从未来任务中选择）
   - 不学了（完成今日学习）

**系统处理流程：**
```
检查当日任务状态 → 判断是否全部完成 → 显示选择界面 → 根据用户选择执行相应操作
```

**选择处理：**
- **学点别的**：用户自己新建任务，系统不介入
- **提前学**：调用推迟任务接口，将未来任务提前到今天
- **不学了**：标记今日学习完成

### 3.2 有任务未完成

**用户操作流程：**
1. 用户有未完成的任务
2. 点击"完成今日学习"
3. 系统显示选择界面：
   - 跳过未完成任务
   - 延期加时学（明天加总学时）
   - 延期学（明天学习，触发重新规划）

**系统处理流程：**
```
检查当日任务状态 → 判断有未完成任务 → 显示选择界面 → 根据用户选择执行相应操作
```

**选择处理：**
- **跳过未完成任务**：调用跳过任务接口
- **延期加时学**：调用推迟任务接口，明天加总学时
- **延期学**：调用推迟任务接口 + 触发自动规划

## 场景4：用户触发重新规划

### 4.1 手动触发重新规划

**用户操作流程：**
1. 用户完成当日任务调整
2. 点击"更新规划"按钮
3. 系统重新安排未开始的任务
4. 显示新的任务安排

**系统处理流程：**
```
用户点击更新规划 → 获取未开始任务 → 清空未来每日任务分配 → 执行自动规划算法 → 生成新的每日任务分配 → 记录操作
```

**重新规划规则：**
- 只重新安排状态为WAITING的任务
- 保持已完成、进行中、跳过的任务不变
- 从明天开始重新分配

## 场景5：用户查看学习进度

### 5.1 查看计划概览

**用户操作流程：**
1. 用户进入计划详情页面
2. 查看计划基本信息
3. 查看任务完成情况
4. 查看学习进度统计

**系统处理流程：**
```
用户请求计划详情 → 获取计划信息 → 获取任务列表 → 计算完成统计 → 返回概览数据
```

### 5.2 查看每日任务

**用户操作流程：**
1. 用户选择查看日期
2. 查看当日任务安排
3. 查看任务完成状态
4. 查看时间分配情况

**系统处理流程：**
```
用户选择日期 → 获取当日任务列表 → 计算时间统计 → 返回每日任务数据
```

## 场景6：用户配置学习偏好

### 6.1 设置每日学习时间

**用户操作流程：**
1. 用户进入设置页面
2. 调整每日最大学习时间
3. 选择自动规划模式
4. 保存配置

**系统处理流程：**
```
用户修改配置 → 验证配置有效性 → 更新UserStudyConfig → 返回更新结果
```

**配置影响：**
- 影响任务时间验证
- 影响自动规划算法
- 影响优化建议生成

## 异常场景处理

### 异常1：任务时间超限

**处理流程：**
1. 系统检测到时间超限
2. 返回错误信息和当前时间统计
3. 提供优化建议
4. 用户调整后重新验证

### 异常2：任务状态冲突

**处理流程：**
1. 系统检测到状态转换不合法
2. 返回错误信息
3. 提示用户正确的操作流程

### 异常3：网络异常

**处理流程：**
1. 系统检测到网络异常
2. 自动重试机制
3. 返回友好的错误提示
4. 保持数据一致性

## 数据一致性保证

### 操作原子性
- 所有任务操作使用数据库事务
- 确保操作要么全部成功，要么全部失败
- 防止数据不一致

### 状态同步
- 任务状态变更自动更新相关表
- 每日任务分配与任务计划日期同步
- 操作记录与业务数据同步

### 并发控制
- 使用乐观锁防止并发冲突
- 操作幂等性保证
- 防止重复操作
