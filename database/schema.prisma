datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
  //    previewFeatures = ["selectRelationCount", "referentialActions"]
}

//  账户
model Account {
  id                Int       @id @default(autoincrement())
  username          String    @unique @db.VarChar(40)
  display_name      String    @db.VarChar(40)
  password          String    @db.VarChar(200)
  role_id           Int
  role              Role      @relation(fields: [role_id], references: [id])
  is_locked         Boolean   @default(false)
  latest_login_ip   String?
  latest_login_time DateTime?
  phone             String?   @unique @db.VarChar(20)

  created_at DateTime @default(now())

  @@map("r_account")
}

//  权限
model Permission {
  id                     Int                      @id @default(autoincrement())
  name                   String                   @unique @db.VarChar(40)
  desc                   String                   @db.VarChar(40)
  permission_type        PermissionType           @default(MENU) //  权限类型
  is_locked              Boolean                  @default(false)
  created_at             DateTime                 @default(now())
  deleted_at             DateTime?
  RolePermissionRelation RolePermissionRelation[]

  @@map("r_permission")
}

enum PermissionType {
  MENU //  菜单
  BUTTON //  按钮
  OTHER //  其它

  @@map("permission_type")
}

//  角色
model Role {
  id                     Int                      @id @default(autoincrement())
  name                   String                   @unique @db.VarChar(40)
  desc                   String                   @db.VarChar(40)
  is_locked              Boolean                  @default(false)
  account                Account[] //  下属用户
  deleted_at             DateTime?
  RolePermissionRelation RolePermissionRelation[]

  @@map("r_role")
}

//  权限与角色关联关系
model RolePermissionRelation {
  permission_id Int //  权限id
  permission    Permission @relation(fields: [permission_id], references: [id])

  role_id Int //  角色id
  role    Role @relation(fields: [role_id], references: [id])

  @@unique([permission_id, role_id])
  @@map("r_role_permission_relation")
}

//  用户
model User {
  id                     Int                      @id @default(autoincrement())
  username               String?                  @db.VarChar(80)
  avatar                 String?                  @db.VarChar(200)
  phone                  String?                  @unique @db.VarChar(20)
  open_id                String                   @db.VarChar(80)
  point                  Int                      @default(0) //  总积分
  created_at             DateTime                 @default(now())
  UserPlan               UserPlan[]
  PresetsTaskTag         PresetsTaskTag[]
  UserTask               UserTask[]
  UserTaskGroup          UserTaskGroup[]
  UserAndTeacherRelation UserAndTeacherRelation[]
  UserStudyConfig        UserStudyConfig?
  UserDailyTask          UserDailyTask[]

  @@map("user")
  UserPlanOperation UserPlanOperation[]
}

//  后台全局系统配置
model SystemConfig {
  id         Int      @id @default(autoincrement())
  name       String   @unique @db.VarChar(80)
  val        String   @db.Text
  remark     String?  @db.VarChar(20)
  created_at DateTime @default(now())
  updated_at DateTime @default(now()) @updatedAt

  @@map("system_config")
}

//  学习计划模版
model PlanTemplate {
  id         Int     @id @default(autoincrement())
  name       String  @db.VarChar(80)
  total_time Int //  总时间（天）
  remark     String? @db.VarChar(20)
  total_use  Int     @default(0)
  is_enable  Boolean @default(true)

  created_at                       DateTime                           @default(now())
  updated_at                       DateTime                           @default(now()) @updatedAt
  PlanTemplateAndTaskGroupRelation PlanTemplateAndTaskGroupRelation[]

  @@map("plan_template")
}

//  学习计划模版与预设任务集合关系 N:N
model PlanTemplateAndTaskGroupRelation {
  plan_template_id Int
  plan_template    PlanTemplate @relation(fields: [plan_template_id], references: [id])

  platform_task_group_id Int
  platform_task_group    PlatformTaskGroup @relation(fields: [platform_task_group_id], references: [id])

  @@unique([plan_template_id, platform_task_group_id])
  @@map("plan_template_and_task_group_relation")
}

enum PlanStatus {
  PROGRESS // 进行中
  PAUSE //  暂停
  COMPLETE //  完成

  @@map("plan_status")
}

//  任务tag，创建用户时自带五个类目,可自行维护增加变更
model PresetsTaskTag {
  id       Int     @id @default(autoincrement())
  user_id  Int
  user     User    @relation(fields: [user_id], references: [id])
  tag_name String  @db.VarChar(80)
  tag_icon String? @db.VarChar(200)

  created_at DateTime @default(now())
  updated_at DateTime @default(now()) @updatedAt

  @@map("task_tag")
}

//  平台预设任务集
model PlatformTaskGroup {
  id   Int    @id @default(autoincrement())
  name String @db.VarChar(80) //  任务集名称

  created_at                       DateTime                           @default(now())
  updated_at                       DateTime                           @default(now()) @updatedAt
  PlanTemplateAndTaskGroupRelation PlanTemplateAndTaskGroupRelation[] //  任务集与【计划】的关系
  PlatformTaskGroupAndTaskRelation PlatformTaskGroupAndTaskRelation[] //  任务集与【任务】的关系

  @@map("platform_task_group")
}

//  平台任务集与预设任务关系 N:N
model PlatformTaskGroupAndTaskRelation {
  platform_task_group_id Int
  platform_task_group    PlatformTaskGroup @relation(fields: [platform_task_group_id], references: [id])

  platform_task_id Int
  platform_task    PlatformTask @relation(fields: [platform_task_id], references: [id])

  @@unique([platform_task_group_id, platform_task_id])
  @@map("platform_task_group_and_task_relation")
}

//  平台预设单个任务
model PlatformTask {
  id                   Int            @id @default(autoincrement())
  name                 String         @db.VarChar(80) //  任务名称
  priority             Int // 优先级
  background           String?        @db.VarChar(10) //  背景色
  suggested_time_start String?        @db.VarChar(20) //  建议时段开始
  suggested_time_end   String?        @db.VarChar(20) //  建议时段结束
  remark               String?        @db.Text //  备注
  annex_type           TaskAnnexType? //  附件类型
  annex                String?        @db.Text //  附件地址
  timing_type          TaskTimingType @default(POMODORO) //  计时类型
  occupation_time      Int? //  所占耗时(min)
  can_divisible        Boolean        @default(false) //  是否可分割

  created_at                       DateTime                           @default(now())
  updated_at                       DateTime                           @default(now()) @updatedAt
  PlatformTaskGroupAndTaskRelation PlatformTaskGroupAndTaskRelation[]

  @@map("platform_task")
}

enum TaskAnnexType {
  IMG // 图片
  FILE //  文件
  URL //  链接

  @@map("task_annex_type")
}

enum TaskTimingType {
  POMODORO //  番茄钟
  FREE_TIMING //  自由计时
  UNTIMING //  不计时

  @@map("task_timing_type")
}

//  学习计划
model UserPlan {
  id      Int        @id @default(autoincrement())
  user_id Int
  user    User       @relation(fields: [user_id], references: [id])
  name    String     @db.VarChar(80) //  任务集名称
  status  PlanStatus @default(PROGRESS) //  执行状态

  planned_start_time DateTime @db.DateTime(3) //  计划开始时间 
  planned_end_time   DateTime @db.DateTime(3) //  计划结束时间

  created_at    DateTime        @default(now())
  updated_at    DateTime        @default(now()) @updatedAt
  UserTaskGroup UserTaskGroup[]

  @@map("user_plan")
}

//  用户任务集
model UserTaskGroup {
  id       Int        @id @default(autoincrement())
  name     String     @db.VarChar(80) //  任务集名称
  user_id  Int
  user     User       @relation(fields: [user_id], references: [id])
  plan_id  Int
  plan     UserPlan   @relation(fields: [plan_id], references: [id])
  UserTask UserTask[]

  created_at DateTime @default(now())
  updated_at DateTime @default(now()) @updatedAt

  @@map("user_task_group")
}

//  用户单个任务
model UserTask {
  id                   Int            @id @default(autoincrement())
  name                 String         @db.VarChar(80) //  任务名称
  task_group_id        Int?
  group                UserTaskGroup? @relation(fields: [task_group_id], references: [id])
  user_id              Int
  user                 User           @relation(fields: [user_id], references: [id])
  priority             Int // 优先级
  background           String?        @db.VarChar(10) //  背景色
  suggested_time_start String?        @db.VarChar(20) //  建议时段开始
  suggested_time_end   String?        @db.VarChar(20) //  建议时段结束
  remark               String?        @db.Text //  备注
  annex_type           TaskAnnexType? //  附件类型
  annex                String?        @db.Text //  附件地址
  timing_type          TaskTimingType @default(POMODORO) //  计时类型
  occupation_time      Int? //  所占耗时(min)
  actual_time          Int? // 实际耗时(min)
  actual_time_start    DateTime? // 实际开始时间
  segment_start        DateTime? // 当前进行段开始（计算用，不展示）
  actual_time_end      DateTime? // 实际结束时间
  last_heartbeat_at    DateTime? // 心跳时间 仅 PROGRESS 状态下更新
  status               TaskStatus     @default(WAITING)
  can_divisible        Boolean        @default(false) //  是否可分割
  planned_date         DateTime?     @db.Date   // 算法排出的「最早执行日期」；为空=未排过
  seq                  Int           @default(0) // 同一天内执行顺序（段级顺序）

  created_at      DateTime          @default(now())
  updated_at      DateTime          @default(now()) @updatedAt
  userTaskLog     userTaskLog[]
  UserTaskSegment UserTaskSegment[]
  UserDailyTask   UserDailyTask[]

  @@map("user_task")
}

//  用户任务变动记录
model userTaskLog {
  id           Int        @id @default(autoincrement())
  user_task_id Int
  user_task    UserTask   @relation(fields: [user_task_id], references: [id])
  from_status  TaskStatus
  to_status    TaskStatus
  created_at   DateTime   @default(now())

  @@map("user_task_log")
}

enum TaskStatus {
  WAITING //  等待开始
  PROGRESS // 进行中
  PAUSE //  暂停
  COMPLETE //  完成
  SKIP //  跳过

  @@map("task_status")
}

//  联系学姐
model Teacher {
  id        Int     @id @default(autoincrement())
  name      String  @db.VarChar(80) //  任务名称
  avatar    String? @db.VarChar(200)
  desc      String  @db.Text //  个人简介
  contact   String  @db.VarChar(80) //  联系方式
  order     Int? //  排序
  is_enable Boolean @default(true) //  是否启用

  created_at             DateTime                 @default(now())
  updated_at             DateTime                 @default(now()) @updatedAt
  UserAndTeacherRelation UserAndTeacherRelation[]

  @@map("teacher")
}

//  督学服务
model UserAndTeacherRelation {
  id         Int      @id @default(autoincrement())
  user_id    Int
  user       User     @relation(fields: [user_id], references: [id])
  teacher_id Int
  teacher    Teacher  @relation(fields: [teacher_id], references: [id])
  start_time DateTime @db.DateTime(3) //  结束时间
  end_time   DateTime @db.DateTime(3) //  开始时间
  is_expired Boolean  @default(false) //  是否过期

  created_at DateTime @default(now())
  updated_at DateTime @default(now()) @updatedAt

  @@unique([user_id, teacher_id])
  @@map("user_and_teacher_relation")
}

// 用户每次「插入/切割/跳过/推迟/重排」都记一条，支持撤销与重放
model UserPlanOperation {
  id              Int             @id @default(autoincrement())
  user_id         Int
  user            User            @relation(fields: [user_id], references: [id])
  plan_id         Int             // 所属学习计划
  operation       PlanOperation   // 操作类型
  payload         Json?            // 操作参数（JSON）
  before_snapshot Json?           // 操作前每日任务快照（可选）
  created_at      DateTime        @default(now())

  @@index([user_id, plan_id, created_at])
  @@map("user_plan_operation")
}

enum PlanOperation {
  INSERT_TASK //  插入任务
  CUT_TASK  //  切割任务
  SKIP_TASK //  跳过任务
  POSTPONE_TASK //  推迟任务
  UPDATE_PLAN   // 点击「更新规划」触发重排
}

// ==========================================
// 1. 学习配置表：保存用户自动规划的顶层开关与偏好
// ==========================================
model UserStudyConfig {
  id      Int  @id @default(autoincrement())
  user_id Int  @unique // 所属用户（一对一）
  user    User @relation(fields: [user_id], references: [id])

  plan_type        StudyPlanType @default(CUSTOM) // 规划类型：CUSTOM=自定义时间；AVG_HOUR=平均每日时长
  avg_hour_per_day Float? // 当 plan_type=AVG_HOUR 时，期望的每日学习小时数（可小数）
  auto_plan_mode   AutoPlanMode  @default(MODE1) // 自动规划算法模式：MODE1~MODE5（任务集/优先度/顺序组合）
  is_locked        Boolean       @default(false) // 用户是否**手动锁定**本配置，锁定后前端不可修改

  created_at DateTime @default(now()) // 配置创建时间
  updated_at DateTime @default(now()) @updatedAt // 最后修改时间

  @@map("user_study_config")
}

// ==========================================
// 2. 每日任务映射表：算法落地后「某一天要做多少分钟」的明细
// ==========================================
model UserDailyTask {
  id      Int  @id @default(autoincrement())
  user_id Int // 所属用户
  user    User @relation(fields: [user_id], references: [id])

  date         DateTime @db.Date // 归属日期（YYYY-MM-DD）
  user_task_id Int // 原始 UserTask 外键
  user_task    UserTask @relation(fields: [user_task_id], references: [id])

  planned_minutes Int // **算法分配**的当天学习时长（分钟）
  done_minutes    Int             @default(0) // 用户**实际完成**时长（分钟），每日反馈回填
  status          DailyTaskStatus @default(PLANNED) // 本条明细状态：PLANNED=计划；AHEAD=提前学；DELAY=延期学；GIVE_UP=放弃
  seq Int @default(0) // 同一天内顺序，从 0 开始，依次递增

  created_at DateTime @default(now()) // 落地时间
  updated_at DateTime @default(now()) @updatedAt // 最后一次更新时间（含 done_minutes 回填）

  // 关系：若任务被分割，一段对多端
  segments UserTaskSegment[] // 本日对应的**任务段**（允许为空：未分割时）

  @@unique([user_id, date, user_task_id]) // 同一天同一任务唯一
  @@index([user_id, date]) // 按日期批量查询快
  @@map("user_daily_task")
}

// ==========================================
// 3. 任务分割段表：把长任务切成小段的「段」级明细
// ==========================================
model UserTaskSegment {
  id           Int      @id @default(autoincrement())
  user_task_id Int // 原始任务 ID
  user_task    UserTask @relation(fields: [user_task_id], references: [id])

  segment_index Int // 段序号（0,1,2...）用于保持顺序
  total_minutes Int // 本段时长（分钟）

  daily_task_id Int? // 若已分配到某天，则外键；为空=未分配
  daily_task    UserDailyTask? @relation(fields: [daily_task_id], references: [id])

  @@unique([user_task_id, segment_index]) // 同一任务下段序号唯一
  @@map("user_task_segment")
}

// ==========================================
// 新增枚举：中文注释已写在字段上，这里再补一次说明
// ==========================================
enum StudyPlanType {
  CUSTOM // 自定义时间类型：按现有任务总时长排布
  AVG_HOUR // 平均每日时长类型：按用户设定的「每日多少小时」反推天数

  @@map("study_plan_type")
}

enum AutoPlanMode {
  MODE1 // 任务集 + 优先度（先任务集前移，再优先度补空）
  MODE2 // 任务集 + 顺序（先任务集前移，再顺序补空）
  MODE3 // 不考虑任务集 + 优先度（全局优先度倒推）
  MODE4 // 不考虑任务集 + 顺序（全局顺序倒推）
  MODE5 // 全局优先度（跨天一次性重排）

  @@map("auto_plan_mode")
}

enum DailyTaskStatus {
  PLANNED // 算法落地后的初始状态
  AHEAD // 用户「提前学」：把未来任务提前到今天
  DELAY // 用户「延期学」：把今天任务延后到未来
  GIVE_UP // 用户「放弃」：不再做这条任务

  @@map("daily_task_status")
}
