datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
  //    previewFeatures = ["selectRelationCount", "referentialActions"]
}

//  账户
model Account {
  id                Int       @id @default(autoincrement())
  username          String    @unique @db.VarChar(40)
  display_name      String    @db.VarChar(40)
  password          String    @db.VarChar(200)
  role_id           Int
  role              Role      @relation(fields: [role_id], references: [id])
  is_locked         Boolean   @default(false)
  latest_login_ip   String?
  latest_login_time DateTime?
  phone             String?   @unique @db.VarChar(20)

  created_at DateTime @default(now())

  @@map("r_account")
}

//  权限
model Permission {
  id                     Int                      @id @default(autoincrement())
  name                   String                   @unique @db.VarChar(40)
  desc                   String                   @db.VarChar(40)
  permission_type        PermissionType           @default(MENU) //  权限类型
  is_locked              Boolean                  @default(false)
  created_at             DateTime                 @default(now())
  deleted_at             DateTime?
  RolePermissionRelation RolePermissionRelation[]

  @@map("r_permission")
}

enum PermissionType {
  MENU //  菜单
  BUTTON //  按钮
  OTHER //  其它

  @@map("permission_type")
}

//  角色
model Role {
  id                     Int                      @id @default(autoincrement())
  name                   String                   @unique @db.VarChar(40)
  desc                   String                   @db.VarChar(40)
  is_locked              Boolean                  @default(false)
  account                Account[] //  下属用户
  deleted_at             DateTime?
  RolePermissionRelation RolePermissionRelation[]

  @@map("r_role")
}

//  权限与角色关联关系
model RolePermissionRelation {
  permission_id Int //  权限id
  permission    Permission @relation(fields: [permission_id], references: [id])

  role_id Int //  角色id
  role    Role @relation(fields: [role_id], references: [id])

  @@unique([permission_id, role_id])
  @@map("r_role_permission_relation")
}

//  用户
model User {
  id                     Int                      @id @default(autoincrement())
  username               String?                  @db.VarChar(80)
  avatar                 String?                  @db.VarChar(200)
  phone                  String?                  @unique @db.VarChar(20)
  open_id                String                   @db.VarChar(80)
  point                  Int                      @default(0) //  总积分
  created_at             DateTime                 @default(now())
  UserPlan               UserPlan[]
  UserTask               UserTask[]
  UserTaskGroup          UserTaskGroup[]
  UserAndTeacherRelation UserAndTeacherRelation[]

  @@map("user")
}

//  后台全局系统配置
model SystemConfig {
  id         Int      @id @default(autoincrement())
  name       String   @unique @db.VarChar(80)
  val        String   @db.Text
  remark     String?  @db.VarChar(20)
  created_at DateTime @default(now())
  updated_at DateTime @default(now()) @updatedAt

  @@map("system_config")
}

//  学习计划模版
model PlanTemplate {
  id         Int     @id @default(autoincrement())
  name       String  @db.VarChar(80)
  total_days Int //  总时间（天）
  total_time Int     @default(0) //  总时长所需（min）
  limit_hour Json //  每日天数时间限制(min)
  remark     String? @db.VarChar(20)
  total_use  Int     @default(0)
  is_enable  Boolean @default(true)

  created_at         DateTime             @default(now())
  updated_at         DateTime             @default(now()) @updatedAt
  PlanTemplateDetail PlanTemplateDetail[]

  @@map("plan_template")
}

//  学习计划模版详情(单个任务集)
model PlanTemplateDetail {
  id               Int          @id @default(autoincrement())
  plan_template_id Int //  模版id
  plan_template    PlanTemplate @relation(fields: [plan_template_id], references: [id])

  platform_task_id       Int //  任务id
  platform_task          PlatformTask       @relation(fields: [platform_task_id], references: [id])
  platform_task_group_id Int? //  任务集id 可选,为空则为单个任务
  platform_task_group    PlatformTaskGroup? @relation(fields: [platform_task_group_id], references: [id])

  priority      Int     @default(9999) // 单个任务的优先级 9999为最低无优先级
  global_sort   Int     @default(1) //  全局排序值，越小越靠前
  group_sort    Int?     //  任务集中的排序值，越小越靠前
  day_sort      Int     @default(1) //  当天内排序值，越小越靠前
  can_divisible Boolean @default(true) //  是否可分割
  date_no       Int     @default(1) //  所属天数序号，从1开始

  @@map("plan_template_detail")
}

enum PlanStatus {
  PROGRESS // 进行中
  PAUSE //  暂停
  COMPLETE //  完成
  CANCEL //  取消

  @@map("plan_status")
}

//  任务tag
model PresetTaskTag {
  id       Int     @id @default(autoincrement())
  tag_name String  @db.VarChar(80)
  tag_icon String? @db.Text
  platformTask PlatformTask[]
  userTask  UserTask[]

  created_at DateTime @default(now())
  updated_at DateTime @default(now()) @updatedAt

  @@map("preset_task_tag")
}

//  平台预设任务集
model PlatformTaskGroup {
  id   Int    @id @default(autoincrement())
  name String @db.VarChar(80) //  任务集名称

  created_at                       DateTime                           @default(now())
  updated_at                       DateTime                           @default(now()) @updatedAt
  PlanTemplateDetail               PlanTemplateDetail[] //  任务集与【计划】的关系
  PlatformTaskGroupAndTaskRelation PlatformTaskGroupAndTaskRelation[] //  任务集与【任务】的关系

  @@map("platform_task_group")
}

//  平台任务集与预设任务关系 N:N
model PlatformTaskGroupAndTaskRelation {
  platform_task_group_id Int
  platform_task_group    PlatformTaskGroup @relation(fields: [platform_task_group_id], references: [id])

  platform_task_id Int
  platform_task    PlatformTask @relation(fields: [platform_task_id], references: [id])

  priority      Int     @default(9999) // 单个任务的优先级 9999为最低无优先级
  group_sort    Int     @default(0) //  任务在任务集中的排序值，越小越靠前
  can_divisible Boolean @default(true) //  是否可分割

  @@unique([platform_task_group_id, platform_task_id])
  @@map("platform_task_group_and_task_relation")
}

//  平台预设单个任务
model PlatformTask {
  id                   Int            @id @default(autoincrement())
  name                 String         @db.VarChar(80) //  任务名称
  preset_task_tag_id Int?
  preset_task_tag    PresetTaskTag? @relation(fields: [preset_task_tag_id], references: [id])
  background           String?        @db.VarChar(10) //  背景色
  suggested_time_start String?        @db.VarChar(20) //  建议时段开始
  suggested_time_end   String?        @db.VarChar(20) //  建议时段结束
  remark               String?        @db.Text //  备注
  annex_type           TaskAnnexType? //  附件类型
  annex                String?        @db.Text //  附件地址
  timing_type          TaskTimingType @default(POMODORO) //  计时类型
  occupation_time      Int //  所占耗时(min)

  created_at                       DateTime                           @default(now())
  updated_at                       DateTime                           @default(now()) @updatedAt
  PlatformTaskGroupAndTaskRelation PlatformTaskGroupAndTaskRelation[]
  PlanTemplateDetail               PlanTemplateDetail[]

  @@map("platform_task")
}

enum TaskAnnexType {
  IMG // 图片
  FILE //  文件
  URL //  链接

  @@map("task_annex_type")
}

enum TaskTimingType {
  POMODORO //  番茄钟
  FREE_TIMING //  自由计时
  UNTIMING //  不计时

  @@map("task_timing_type")
}

//  学习计划
model UserPlan {
  id         Int        @id @default(autoincrement())
  user_id    Int
  user       User       @relation(fields: [user_id], references: [id])
  name       String     @db.VarChar(80) //  计划名称
  status     PlanStatus @default(PROGRESS) //  执行状态
  total_days Int        @default(0) //  计划总天数
  total_time Int        @default(0) //  总时长所需（min）
  limit_hour Json //  每日天数时间限制(min)

  planned_start_time DateTime @db.DateTime(3) //  计划开始时间 

  created_at DateTime   @default(now())
  updated_at DateTime   @default(now()) @updatedAt

  @@map("user_plan")
  UserTaskScheduler UserTaskScheduler[]
  UserTaskGroup UserTaskGroup[]
  UserTask UserTask[]
  UserPlanDayTrack UserPlanDayTrack[]
}

//  用户日跟踪标记
model UserPlanDayTrack {
  id         Int      @id @default(autoincrement())
  plan_id    Int
  plan       UserPlan @relation(fields: [plan_id], references: [id])
  date_no    Int //  日期序号，从1开始
  is_complete Boolean @default(false) //  该日是否已完成（打卡完成）
  completed_at DateTime? @db.DateTime(3) //  完成时间
  total_time Int @default(0) //  该日计划总时间（分钟）
  
  learning_experience String? @db.Text //  学习心得
  annex                String?        @db.Text //  附件地址
  score                Json?          //  评分

  created_at DateTime @default(now())
  updated_at DateTime @default(now()) @updatedAt
  UserTaskScheduler UserTaskScheduler[]

  @@unique([plan_id, date_no])
  @@map("user_plan_day_track")
}

//  用户任务集
model UserTaskGroup {
  id       Int        @id @default(autoincrement())
  plan_id              Int
  plan                 UserPlan      @relation(fields: [plan_id], references: [id])
  name     String     @db.VarChar(80) //  任务集名称
  user_id  Int
  user     User       @relation(fields: [user_id], references: [id])
  UserTask UserTask[]

  created_at DateTime @default(now())
  updated_at DateTime @default(now()) @updatedAt

  @@map("user_task_group")
}

//  用户任务日期调度
model UserTaskScheduler {
  //  关联的日跟踪记录id
  track_id Int
  track    UserPlanDayTrack @relation(fields: [track_id], references: [id])

  plan_id              Int
  plan                 UserPlan      @relation(fields: [plan_id], references: [id])

  task_id Int      @unique
  task    UserTask @relation(fields: [task_id], references: [id])

  priority      Int     @default(9999) // 单个任务的优先级 9999为最低无优先级
  global_sort   Int     @default(1) //  任务集合中的全局排序值，越小越靠前
  group_sort    Int?      //  任务集中的排序值，越小越靠前  没有则为零散任务
  day_sort      Int     @default(1) //  当天内排序值，越小越靠前
  can_divisible Boolean @default(true) //  是否可分割
  date_no       Int     @default(1) //  所属天数序号，从1开始
  is_postpone   Boolean @default(false) //  是否被顺延

  status            TaskStatus     @default(WAITING)
  @@map("user_task_scheduler")
}

//  用户单个任务
model UserTask {
  id                   Int            @id @default(autoincrement())
  plan_id              Int
  plan                 UserPlan      @relation(fields: [plan_id], references: [id])
  name                 String         @db.VarChar(80) //  任务名称
  task_group_id        Int? //  没有则为零散任务
  group                UserTaskGroup? @relation(fields: [task_group_id], references: [id])
  user_id              Int
  user                 User           @relation(fields: [user_id], references: [id])
  preset_task_tag_id Int?
  preset_task_tag    PresetTaskTag? @relation(fields: [preset_task_tag_id], references: [id])
  background           String?        @db.VarChar(10) //  背景色
  suggested_time_start String?        @db.VarChar(20) //  建议时段开始
  suggested_time_end   String?        @db.VarChar(20) //  建议时段结束
  remark               String?        @db.Text //  备注
  annex_type           TaskAnnexType? //  附件类型
  annex                String?        @db.Text //  附件地址

  timing_type       TaskTimingType @default(POMODORO) //  计时类型
  occupation_time   Int //  所占耗时(min)
  actual_time       Int? // 实际耗时(min)
  actual_time_start DateTime? // 实际开始时间
  segment_start     DateTime? // 当前进行段开始（计算用，不展示）
  actual_time_end   DateTime? // 实际结束时间
  last_heartbeat_at DateTime? // 心跳时间 仅 PROGRESS 状态下更新
  status            TaskStatus     @default(WAITING)
  can_divisible     Boolean        @default(true) //  是否可分割

  created_at        DateTime            @default(now())
  updated_at        DateTime            @default(now()) @updatedAt
  userTaskLog       userTaskLog[]
  UserTaskScheduler UserTaskScheduler[]

  @@map("user_task")
}

//  用户任务变动记录
model userTaskLog {
  id           Int        @id @default(autoincrement())
  user_task_id Int
  user_task    UserTask   @relation(fields: [user_task_id], references: [id])
  from_status  TaskStatus
  to_status    TaskStatus
  created_at   DateTime   @default(now())

  @@map("user_task_log")
}

enum TaskStatus {
  WAITING //  等待开始
  PROGRESS // 进行中
  PAUSE //  暂停
  COMPLETE //  完成
  SKIP //  跳过

  @@map("task_status")
}

//  联系学姐
model Teacher {
  id        Int     @id @default(autoincrement())
  name      String  @db.VarChar(80) //  任务名称
  avatar    String? @db.VarChar(200)
  desc      String  @db.Text //  个人简介
  contact   String  @db.VarChar(80) //  联系方式
  order     Int? //  排序
  is_enable Boolean @default(true) //  是否启用

  created_at             DateTime                 @default(now())
  updated_at             DateTime                 @default(now()) @updatedAt
  UserAndTeacherRelation UserAndTeacherRelation[]

  @@map("teacher")
}

//  督学服务
model UserAndTeacherRelation {
  id         Int      @id @default(autoincrement())
  user_id    Int
  user       User     @relation(fields: [user_id], references: [id])
  teacher_id Int
  teacher    Teacher  @relation(fields: [teacher_id], references: [id])
  start_time DateTime  //  结束时间
  end_time   DateTime  //  开始时间
  is_expired Boolean  @default(false) //  是否过期

  created_at DateTime @default(now())
  updated_at DateTime @default(now()) @updatedAt

  @@unique([user_id, teacher_id])
  @@map("user_and_teacher_relation")
}

enum PlanOperation {
  INSERT_TASK //  插入任务
  CUT_TASK //  切割任务
  SKIP_TASK //  跳过任务
  POSTPONE_TASK //  推迟任务
  UPDATE_PLAN // 点击「更新规划」触发重排
}
